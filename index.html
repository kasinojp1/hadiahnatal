<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>User - Tebak Kartu Natal</title>
<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:#08121c url('https://i.ibb.co/6YpYQZT/snow-bg.png') repeat;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:20px;
  overflow-x:hidden;
  position:relative;
}

/* Salju animasi */
@keyframes snow{
  0%{transform: translateY(0);}
  100%{transform: translateY(100vh);}
}
.snowflake{
  position:absolute;
  top:-10px;
  font-size:1em;
  color:#fff;
  animation: snow linear infinite;
  pointer-events:none;
}

.wrap{
  width:100%;
  max-width:920px;
  background:linear-gradient(145deg,#111 0%,#1c1c2b 100%);
  padding:20px;
  border-radius:20px;
  border:2px solid #d4af37;
  box-shadow:0 0 30px rgba(212,175,55,0.5);
}

h1{
  color:#d4af37;
  margin-bottom:15px;
  text-align:center;
  text-shadow: 0 0 10px #d4af37;
}

.code-row{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  margin-bottom:20px;
}

input{
  padding:12px;
  border-radius:12px;
  border:none;
  background:#0b0f10;
  color:#fff;
  width:200px;
  text-align:center;
  font-weight:600;
}

.btn{
  background:#d4af37;
  color:#111;
  padding:12px 20px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:600;
  transition:0.3s;
}
.btn:hover{
  transform: scale(1.05);
  box-shadow:0 0 20px #d4af37;
}

.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}

.card{
  height:160px;
  border-radius:15px;
  background:#0b0b0b;
  border:2px solid #d4af37;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  position:relative;
  transition: transform .6s;
  transform-style: preserve-3d;
  box-shadow:0 0 15px rgba(212,175,55,0.2);
}

.card.flip{
  transform: rotateY(180deg);
}

.card.locked{
  filter:grayscale(.2) blur(.5px);
  cursor:not-allowed;
}

.card .front, .card .back{
  position:absolute;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:15px;
  backface-visibility:hidden;
  font-size:18px;
  font-weight:700;
}

.card .front{
  background:#0b0b0b;
  color:#fff;
}

.card .back{
  background:linear-gradient(135deg,#d61c1c,#1cd670);
  color:#fff;
  transform:rotateY(180deg);
  display:flex;
  flex-direction:column;
}

.badge{
  position:absolute;
  top:10px;
  right:10px;
  background:rgba(0,0,0,0.4);
  color:#fff;
  padding:4px 6px;
  border-radius:6px;
  font-weight:700;
}

.result-area{
  margin-top:20px;
  max-height:200px;
  overflow-y:auto;
  font-size:14px;
}

.small{
  font-size:13px;
  color:#bfc6c9;
}

.prize-list{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:20px;
  justify-content:center;
}

.prize-item{
  flex:1 1 28%;
  background:linear-gradient(135deg,#d61c1c,#1cd670);
  padding:12px;
  border-radius:12px;
  text-align:center;
  font-size:16px;
  font-weight:600;
  color:#fff;
  box-shadow:0 0 15px rgba(212,175,55,0.4);
  transition:0.3s;
}
.prize-item:hover{
  transform: scale(1.05);
}
</style>
</head>
<body>
<div class="wrap">
<h1>Tebak Kartu Natal üéÑ</h1>
<div class="code-row">
<input id="codeInput" placeholder="Masukkan kode..."/>
<button id="verifyBtn" class="btn">Verify</button>
<div class="small" id="status">Status: belum terkoneksi</div>
</div>

<div class="prize-list">
  <div class="prize-item">Platinum: 10,000</div>
  <div class="prize-item">Diamond: 25,000</div>
  <div class="prize-item">Super Diamond: 500,000</div>
</div>

<div id="gridWrap" class="grid"></div>
<div class="result-area" id="resultArea"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlpuf_uIlpmr2ybAqpJ2GTTRW-t86PGf0",
  authDomain: "hadiahnatal-a033b.firebaseapp.com",
  databaseURL: "https://hadiahnatal-a033b-default-rtdb.firebaseio.com",
  projectId: "hadiahnatal-a033b",
  storageBucket: "hadiahnatal-a033b.firebasestorage.app",
  messagingSenderId: "577153304596",
  appId: "1:577153304596:web:5f255e886a379ccb12bf01",
  measurementId: "G-C5Q83YQ6SK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "gameConfig/cards");
const usedRef = ref(db, "gameConfig/usedCodes");

const gridWrap=document.getElementById('gridWrap');
const verifyBtn=document.getElementById('verifyBtn');
const codeInput=document.getElementById('codeInput');
const status=document.getElementById('status');
const resultArea=document.getElementById('resultArea');

let serverConfig=null;
let unlocked=false;
let revealed=new Set();
let maxSelect=3;
let selectedCount=0;

function buildGrid(){
  gridWrap.innerHTML='';
  for(let i=0;i<9;i++){
    const c=document.createElement('div');
    c.className='card locked';
    c.dataset.index=i;
    c.innerHTML=`<div class="front">Kartu ${i+1}</div><div class="back"><span class="label">?</span></div>`;
    c.addEventListener('click',onCardClick);
    gridWrap.appendChild(c);
  }
}

function setStatus(txt){status.textContent='Status: '+txt;}

function fetchConfig(){
  onValue(dbRef,(snap)=>{
    if(snap.exists()){
      serverConfig = snap.val();
      setStatus('Siap - data tersedia üéÅ');
      if(!unlocked) buildGrid();
    }else setStatus('Belum ada konfigurasi');
  });
}

async function onCardClick(e){
  if(selectedCount>=maxSelect) return;
  const el = e.currentTarget;
  const idx = Number(el.dataset.index);
  if(!unlocked || revealed.has(idx)) return;

  const cards = serverConfig?.cards||[];
  const value = cards[idx]||'Kosong';
  el.classList.add('flip');
  el.querySelector('.label').textContent = value;
  revealed.add(idx);
  selectedCount++;

  const msg = document.createElement('div');
  msg.className = 'small';
  msg.textContent = `Kamu membuka Kartu ${idx+1}: ${value}`;
  resultArea.prepend(msg);

  if(selectedCount>=maxSelect){
    saveUsedCode();
  }
}

async function saveUsedCode(){
  const code = codeInput.value.trim();
  if(!code || !serverConfig) return;
  const snap = await get(ref(db, "gameConfig/usedCodes/"+code));
  if(snap.exists()){ setStatus("Kode sudah dipakai ‚ùå"); return; }
  const cardsArr = Array.from(gridWrap.querySelectorAll('.card')).map(c=>c.classList.contains('flip')?c.querySelector('.label').textContent:null);
  await set(ref(db,"gameConfig/usedCodes/"+code), {cards:cardsArr, time:Date.now()});
  setStatus("Kode & kartu tersimpan üéÑ");
}

verifyBtn.addEventListener('click',()=>{
  const code = codeInput.value.trim();
  if(!serverConfig){setStatus('Tidak ada konfigurasi'); return;}
  if(code===serverConfig.code){
    unlocked=true; 
    setStatus('Kode benar ‚Äî pilih kartu! üéÅ'); 
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('locked'));
  } else{
    unlocked=false; 
    setStatus('Kode salah ‚ùå');
  }
});

buildGrid();
fetchConfig();
</script>
</body>
</html>
