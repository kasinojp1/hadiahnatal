<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>User - Tebak Kartu Natal (Final)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#060d1c;
    --bg2:#0a1428;
    --gold:#ffe9a3;
    --gold2:#d4af37;
    --muted:#c7ccd1;
  }
  *{box-sizing:border-box;margin:0;padding:0}

  body{
    font-family:'Poppins',sans-serif;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#fff;
    padding:14px;
    overflow-x:hidden;
  }

  /* background anim */
  .dec{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:0;}
  .tree,.snow{position:absolute;}
  .tree{
    width:36px;height:52px;
    background:linear-gradient(#0b8c24,#1fe06f);
    clip-path:polygon(50% 0,0 100%,100% 100%);
    opacity:.75;
    filter:drop-shadow(0 4px 12px rgba(0,0,0,.6));
    animation:treeFall linear infinite;
  }
  @keyframes treeFall{
    0%{transform:translateY(-80px) scale(.6);opacity:1}
    100%{transform:translateY(110vh) scale(1);opacity:0}
  }
  .snow{
    width:8px;height:8px;border-radius:50%;background:white;opacity:.8;
    animation:snowFall linear infinite;
  }
  @keyframes snowFall{
    0%{transform:translateY(-30px) scale(1)}
    100%{transform:translateY(120vh) scale(.7)}
  }

  /* container */
  .wrap{
    width:100%;max-width:480px;margin:auto;
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:18px;
    padding:22px;
    box-shadow:0 10px 40px rgba(0,0,0,.6);
    position:relative;z-index:2;
  }

  header h1{
    font-size:22px;
    color:var(--gold);
    text-align:center;
    margin-bottom:6px;
  }
  header p{
    text-align:center;
    font-size:13px;
    color:var(--muted);
  }

  .code-row{
    margin-top:18px;
    display:flex;gap:12px;flex-wrap:wrap;
  }
  input{
    flex:1;
    padding:12px 14px;
    background:#0c141b;
    color:#fff;border:none;
    border-radius:10px;
    font-weight:600;
  }
  .btn{
    background:var(--gold);
    color:#111;
    border:none;
    padding:11px 16px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
  }
  .btn:disabled{opacity:.5}

  #status{
    text-align:center;
    width:100%;
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
  }

  /* prize */
  .prize-list{
    margin-top:22px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    justify-content:center;
  }
  .prize{
    background:linear-gradient(135deg,#ff4e4e,#ffa94d,#4caf50);
    padding:14px;width:46%;
    min-width:160px;
    text-align:center;
    border-radius:14px;
    color:#111;
    font-weight:800;
    font-size:16px;
    border:2px solid rgba(255,255,255,0.12);
    position:relative;
    box-shadow:0 8px 25px rgba(0,0,0,.45);
  }
  .prize::before{
    content:"üéÑ";
    position:absolute;
    top:-10px;left:12px;font-size:20px;
  }
  .prize small{
    display:block;
    margin-top:6px;
    color:#222;
    font-size:12px;
  }

  /* kartu grid */
  .grid{
    margin-top:26px;
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:16px;
  }

  .card{
    height:150px;
    perspective:1200px;
    position:relative;
    cursor:pointer;
    border-radius:14px;
  }
  .card.locked{
    filter:grayscale(.4);
    cursor:not-allowed;
    opacity:.85;
  }

  .card-inner{
    width:100%;height:100%;
    transition:transform .6s;
    transform-style:preserve-3d;
  }
  .card.flip .card-inner{
    transform:rotateY(180deg);
  }
  .card-front,.card-back{
    position:absolute;inset:0;
    display:flex;align-items:center;justify-content:center;
    backface-visibility:hidden;
    border-radius:14px;
    font-weight:700;text-align:center;
    padding:10px;
  }
  .card-front{
    background:linear-gradient(180deg,#071018,#0c1115);
    border:1px solid rgba(255,255,255,0.05);
    color:var(--muted);
  }
  .card-back{
    background:linear-gradient(135deg,#fff7cd,#ffd76f);
    color:#111;
    transform:rotateY(180deg);
  }

  /* result */
  .result{
    margin-top:18px;
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:center;
    font-size:13px;
  }
  .result .small{color:var(--muted)}

  /* confetti */
  .confetti{
    position:fixed;width:8px;height:8px;border-radius:2px;
    pointer-events:none;
    animation:confettiDrop 900ms linear forwards;
    z-index:30;
  }
  @keyframes confettiDrop{
    0%{transform:translateY(0) rotate(0);opacity:1}
    100%{transform:translateY(180px) rotate(360deg);opacity:0}
  }

  @media(max-width:720px){
    .prize{width:47%}
    .card{height:130px}
  }
</style>
</head>

<body>

<div class="dec" id="decContainer"></div>

<main class="wrap">
<header>
  <h1>Event Tebak Kartu ‚Äî Natal KASINOJP</h1>
  <p>Masukkan kode dari admin, pilih 3 kartu ‚Äî kode hanya sekali pakai.</p>
</header>

<div class="code-row">
  <input id="codeInput" type="text" placeholder="Masukkan kode akses...">
  <button id="verifyBtn" class="btn">Verify</button>
</div>

<div id="status">Status: belum terkoneksi</div>

<div class="prize-list">
  <div class="prize">üéÅ PLATINUM <small>10,000</small></div>
  <div class="prize">üéÅ DIAMOND <small>25,000</small></div>
  <div class="prize">üéÅ SILVER DIAMOND <small>50,000</small></div>
  <div class="prize">üéÅ PERFECT DIAMOND <small>100,000</small></div>
  <div class="prize">üéÅ EPIC DIAMOND <small>150,000</small></div>
  <div class="prize">üéÅ MHYTIC DIAMOND <small>400,000</small></div>
</div>

<section id="gridWrap" class="grid"></section>
<div id="resultArea" class="result"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDlpuf_uIlpmr2ybAqpJ2GTTRW-t86PGf0",
  authDomain:"hadiahnatal-a033b.firebaseapp.com",
  databaseURL:"https://hadiahnatal-a033b-default-rtdb.firebaseio.com",
  projectId:"hadiahnatal-a033b",
  storageBucket:"hadiahnatal-a033b.firebasestorage.app",
  messagingSenderId:"577153304596",
  appId:"1:577153304596:web:5f255e886a379ccb12bf01",
  measurementId:"G-C5Q83YQ6SK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const configRef = ref(db, "gameConfig/cards");

const decContainer=document.getElementById('decContainer');
const gridWrap=document.getElementById('gridWrap');
const verifyBtn=document.getElementById('verifyBtn');
const codeInput=document.getElementById('codeInput');
const statusEl=document.getElementById('status');
const resultArea=document.getElementById('resultArea');

let serverConfig=null;
let unlocked=false;
let revealed=new Set();
let selectedCount=0;
const maxSelect=3;

/* background anim */
function spawnTree(){
  const t=document.createElement('div');
  t.className='tree';
  t.style.left=(Math.random()*100)+'vw';
  t.style.animationDuration=(7+Math.random()*6)+'s';
  decContainer.appendChild(t);
  setTimeout(()=>t.remove(),15000);
}
function spawnSnow(){
  const s=document.createElement('div');
  s.className='snow';
  s.style.left=(Math.random()*100)+'vw';
  s.style.animationDuration=(3+Math.random()*6)+'s';
  decContainer.appendChild(s);
  setTimeout(()=>s.remove(),9000);
}
setInterval(spawnTree,900);
setInterval(spawnSnow,140);

/* Build Grid */
function buildGrid(){
  gridWrap.innerHTML='';
  for(let i=0;i<9;i++){
    const c=document.createElement('div');
    c.className='card locked';
    c.dataset.index=i;
    c.innerHTML=`
      <div class="card-inner">
        <div class="card-front">Kartu ${i+1}</div>
        <div class="card-back"><span class="label">?</span></div>
      </div>`;
    c.addEventListener('click',onCardClick);
    gridWrap.appendChild(c);
  }
}

/* status */
function setStatus(txt,ok=true){
  statusEl.textContent='Status: '+txt;
  statusEl.style.color=ok?'var(--muted)':'#ff8f8f';
}

/* load config */
onValue(configRef,snap=>{
  if(snap.exists()){
    serverConfig=snap.val();
    setStatus('Siap ‚Äî data tersedia üéÅ');
    if(!unlocked) buildGrid();
  }else{
    serverConfig=null;
    setStatus('Belum ada konfigurasi admin',false);
    buildGrid();
  }
});

/* verify code */
async function verifyCode(code){
  try{
    const usedSnap=await get(ref(db,"gameConfig/usedCodes/"+code));
    if(usedSnap.exists()) return {ok:false,msg:"Kode sudah dipakai"};
    if(!serverConfig) return {ok:false,msg:"Tidak ada data admin"};
    if(code !== (serverConfig.code||'')) return{ok:false,msg:"Kode salah"};
    return {ok:true,msg:"Kode valid"};
  }catch(err){
    return{ok:false,msg:"Error verifikasi"};
  }
}

/* card click */
async function onCardClick(e){
  if(!unlocked) return;
  if(selectedCount>=maxSelect) return;

  const el=e.currentTarget;
  const idx=Number(el.dataset.index);
  if(revealed.has(idx)) return;

  const cardsArr=serverConfig?.cards||[];
  let val=cardsArr[idx]||'Kosong';

  if(selectedCount>0 && val!==cardsArr[0]) val='ZONK';

  el.classList.add('flip');
  el.querySelector('.label').textContent=val;

  revealed.add(idx);
  selectedCount++;

  const msg=document.createElement('div');msg.className='small';
  msg.textContent=`Kartu ${idx+1}: ${val}`;
  resultArea.prepend(msg);

  if(["Platinum","Diamond","Super Diamond"].includes(val)){
    const r=el.getBoundingClientRect();
    spawnConfetti(r.left+r.width/2,r.top+r.height/2);
  }

  if(selectedCount>=maxSelect){
    await saveUsedCode();
    document.querySelectorAll('.card').forEach(c=>c.classList.add('locked'));
    const done=document.createElement('div');
    done.className='small';
    done.textContent='üéâ Hadiah keluar! Hubungi admin untuk claim.';
    resultArea.prepend(done);
  }
}

/* confetti */
function spawnConfetti(x,y){
  for(let i=0;i<20;i++){
    const el=document.createElement('div');
    el.className='confetti';
    el.style.left=(x+(Math.random()*80-40))+'px';
    el.style.top=(y+(Math.random()*40-20))+'px';
    el.style.background=['#ffe9a3','#ff4d4d','#4caf50','#ffffff'][Math.floor(Math.random()*4)];
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),900);
  }
}

/* save used code */
async function saveUsedCode(){
  const code=codeInput.value.trim();
  if(!code){setStatus('Kode kosong',false);return;}

  try{
    const snap=await get(ref(db,"gameConfig/usedCodes/"+code));
    if(snap.exists()){setStatus('Kode sudah dipakai',false);return;}

    const cardsResult=[...gridWrap.querySelectorAll('.card')]
      .map(c=>c.classList.contains('flip')?c.querySelector('.label').textContent:null);

    await set(ref(db,"gameConfig/usedCodes/"+code),{
      cards:cardsResult,
      time:Date.now(),
      used:true
    });

    setStatus('Tersimpan ‚úì');
    unlocked=false;
    verifyBtn.disabled=true;
    codeInput.disabled=true;
  }catch(err){
    setStatus('Gagal menyimpan',false);
  }
}

/* verify btn */
verifyBtn.addEventListener('click',async()=>{
  const code=codeInput.value.trim();
  if(!code){setStatus('Masukkan kode',false);return;}
  setStatus('Memeriksa...');
  verifyBtn.disabled=true;

  const res=await verifyCode(code);
  verifyBtn.disabled=false;

  if(!res.ok){setStatus(res.msg,false);unlocked=false;return;}

  unlocked=true;
  selectedCount=0;
  revealed.clear();
  buildGrid();
  setStatus('Kode valid ‚Äî pilih 3 kartu üéÅ');
});

/* init */
buildGrid();
</script>

</body>
</html>
