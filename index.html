<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>User - Tebak Kartu</title>
<style>
body{
  margin:0;
  font-family:Inter,Poppins,sans-serif;
  background:#080808;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:20px;
}
.wrap{
  width:100%;
  max-width:920px;
  background:#111;
  padding:20px;
  border-radius:12px;
  border:1px solid rgba(212,175,55,0.1);
}
h1{color:#d4af37;margin-bottom:10px;}
.code-row{display:flex;gap:10px;align-items:center;margin-bottom:18px;flex-wrap:wrap;}
input{padding:10px;border-radius:8px;border:none;background:#0b0f10;color:#fff;flex:1;}
.btn{background:#d4af37;color:#111;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
  perspective:1000px;
}
.card{
  height:140px;
  border-radius:10px;
  background:#0b0b0b;
  border:1px solid rgba(212,175,55,0.05);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  position:relative;
  transition:transform .5s;
  transform-style: preserve-3d;
}
.card.flipped{
  transform: rotateY(180deg);
}
.card.locked{filter:grayscale(.2) blur(.2px);cursor:not-allowed;}
.card .front,.card .back{
  position:absolute;
  width:100%;
  height:100%;
  backface-visibility:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
}
.card .front{background:#0b0b0b;color:#bfc6c9;}
.card .back{background:rgba(212,175,55,0.1);color:#111;transform:rotateY(180deg);}
.badge{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.4);color:#d4af37;padding:4px 6px;border-radius:6px;font-weight:700;}
.result-area{margin-top:16px;}
.small{font-size:13px;color:#bfc6c9;}
.prize-list{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:12px;
}
.prize-item{
  flex:1 1 30%;
  background:#0b0b0b;
  padding:8px;
  border-radius:8px;
  border:1px solid rgba(212,175,55,0.05);
  text-align:center;
  font-size:14px;
}
</style>
</head>
<body>
<div class="wrap">
<h1>Tebak Kartu</h1>
<div class="code-row">
<input id="codeInput" placeholder="Masukkan kode..."/>
<button id="verifyBtn" class="btn">Verify</button>
<div class="small" id="status">Status: belum terkoneksi</div>
</div>

<div class="prize-list">
  <div class="prize-item">Platinum: 10,000</div>
  <div class="prize-item">Diamond: 25,000</div>
  <div class="prize-item">Super Diamond: 500,000</div>
</div>

<div id="gridWrap" class="grid"></div>
<div class="result-area" id="resultArea"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlpuf_uIlpmr2ybAqpJ2GTTRW-t86PGf0",
  authDomain: "hadiahnatal-a033b.firebaseapp.com",
  databaseURL: "https://hadiahnatal-a033b-default-rtdb.firebaseio.com",
  projectId: "hadiahnatal-a033b",
  storageBucket: "hadiahnatal-a033b.firebasestorage.app",
  messagingSenderId: "577153304596",
  appId: "1:577153304596:web:5f255e886a379ccb12bf01",
  measurementId: "G-C5Q83YQ6SK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "gameConfig/cards");
const usedRef = ref(db, "gameConfig/usedCodes");

const gridWrap=document.getElementById('gridWrap');
const verifyBtn=document.getElementById('verifyBtn');
const codeInput=document.getElementById('codeInput');
const status=document.getElementById('status');
const resultArea=document.getElementById('resultArea');

let serverConfig=null;
let unlocked=false;
let revealed=new Set();
const maxSelect=3;
let selectedCount=0;

function buildGrid(){
  gridWrap.innerHTML='';
  for(let i=0;i<9;i++){
    const c=document.createElement('div');
    c.className='card locked';
    c.dataset.index=i;
    c.innerHTML=`
      <div class="front">Kartu ${i+1}</div>
      <div class="back">?</div>
    `;
    c.addEventListener('click',onCardClick);
    gridWrap.appendChild(c);
  }
}

function setStatus(txt){
  status.textContent='Status: '+txt;
}

onValue(dbRef,(snap)=>{
  if(snap.exists()){
    serverConfig = snap.val();
    setStatus('Siap - data tersedia');
    if(!unlocked) buildGrid();
  } else {
    setStatus('Belum ada konfigurasi');
  }
});

function onCardClick(e){
  if(selectedCount>=maxSelect) return;
  const el=e.currentTarget;
  const idx=Number(el.dataset.index);
  if(!unlocked || revealed.has(idx)) return;

  const cards = serverConfig?.cards||[];
  const value = cards[idx] || 'Kosong';

  el.classList.add('flipped');
  el.querySelector('.back').textContent = value;
  revealed.add(idx);
  selectedCount++;

  const msg=document.createElement('div');
  msg.className='small';
  msg.textContent=`Kamu membuka Kartu ${idx+1}: ${value}`;
  resultArea.prepend(msg);

  // Simpan ke usedCodes jika sudah pilih max
  if(selectedCount>=maxSelect){
    saveUsedCode();
  }
}

async function saveUsedCode(){
  if(!serverConfig) return;
  const code = codeInput.value.trim();
  const cards = Array.from(gridWrap.querySelectorAll('.card')).map(c=>{
    return c.classList.contains('flipped') ? c.querySelector('.back').textContent : null;
  });
  try{
    const snap = await get(ref(db, "gameConfig/usedCodes/"+code));
    if(snap.exists()){
      setStatus("Kode sudah pernah dipakai");
      return;
    }
    await set(ref(db, "gameConfig/usedCodes/"+code), {
      cards,
      createdAt: Date.now(),
      used: true
    });
    setStatus("Kode & kartu tersimpan di histori ✓");
  }catch(err){
    console.error(err);
    setStatus("Gagal menyimpan: "+err.message);
  }
}

verifyBtn.addEventListener('click',()=>{
  const code = (codeInput.value||'').trim();
  if(!serverConfig){setStatus('Tidak ada konfigurasi');return;}
  if(code===serverConfig.code){
    unlocked=true;
    setStatus('Kode benar — pilih kartu!');
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('locked'));
  } else {
    unlocked=false;
    setStatus('Kode salah');
  }
});

buildGrid();
</script>
</body>
</html>
